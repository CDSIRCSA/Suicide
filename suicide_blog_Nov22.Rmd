---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(plotly)
library(hablar)
library(rgdal)
library(sf)
library(zeallot)
library(ggalt)
library(rjson)
library(htmlwidgets)
```

Load the data from REDCap
```{r}
token <- "80395861F2E51154EC9FD8E6FF037B0D"
url <- "https://dfe-redcap.azurewebsites.net/redcap/api/"

formData <- list("token"=token,
                 content='record',
                 action='export',
                 format='csv',
                 type='flat',
                 csvDelimiter='',
                 fields='case_number, year_of_death, age_years, age_group, sex, cultural_background, category_of_death, seifa_disadvantage, 
    state, region, residential_status, postcode, disability_register, cald',
                 filterLogic='[exclude_case]=0 AND [year_of_death]<=2022',
                 rawOrLabel='label',
                 rawOrLabelHeaders='raw',
                 exportCheckboxLabel='false',
                 exportSurveyFields='false',
                 exportDataAccessGroups='false',
                 returnFormat='json'
)
response <- httr::POST(url, body = formData, encode = "form")
data <- httr::content(response)
```

Transform the data
```{r}
data = data %>% 
  mutate(age_group = fct_relevel(age_group, "< 28 days", "1 to 11 months", "1 to 4 years", "5 to 9 years", "10 to 14 years", "15 to 17 years"))

suicides = filter(data, category_of_death == "Suicide")
```

STATS
Number of suicides and age range
```{r}
n_suicides = nrow(suicides)
min_age = min(suicides$age_years)
max_age = max(suicides$age_years)
perc_suicides = round((nrow(suicides)/nrow(filter(data, age_years>=min_age)))*100,0)

paste0("The Committee has determined that ", n_suicides, " young people – aged from ", min_age, " to ", max_age, " years – have suicided since 2005, ", perc_suicides, "% of the total number of children in that age range who have died in South Australia since 2005.")
```

Category of death ranking
```{r}
filter(data, age_years >= min_age) %>% 
  count(category_of_death) %>% 
  arrange(desc(n))
```


FIGURES
Figure 1
```{r}
custom_colours <- c("#000000", "#FEB627", "#7E7E7E", "#27B9FE", "#FFFFFF")
line_colours <- setNames(custom_colours[c(2, 4, 3)],
                         c("Female", "Male", "Total"))
yearly_suicides <- suicides %>% count(year_of_death, sex) %>% complete(year_of_death, sex, fill=list(n=0)) %>% mutate(type = 1) %>% 
  bind_rows(suicides %>% count(year_of_death) %>% mutate(sex = "Total", type = 2))

# Figure 1
(figure1_line <- plot_ly(data = filter(yearly_suicides, sex=="Total"),
                    type = "scatter",
                    mode = "lines",
                    x = ~year_of_death,
                    y = ~n,
                    hovertemplate = paste0("Number of deaths: ","%{y}"),
                    line = list(width = 4, dash="dash", color=custom_colours[3]), name="Total") %>% 
    add_trace(data = filter(yearly_suicides, sex=="Male"),
              y = ~n,
              line = list(width = 4, dash='solid', color=custom_colours[4]),
              name = "Male") %>% 
    add_trace(data = filter(yearly_suicides, sex=="Female"),
              y = ~n,
              line = list(width = 4, dash='solid', color=custom_colours[2]),
              name = "Female") %>% 
    layout(xaxis = list(title = "Year",
                        tickvals = list(2005,2007,2009,2011,2013,2015,2017,2019,2021),
                        range = c(2004, 2022)),
           yaxis = list(title = "Number of suicides",
                        range = c(0, 10)),
           font = list(size = 14),
           legend = list(x = 0.08, y = 0.93, bgcolor = "rgba(0, 0, 0, 0)")))

saveWidget(figure1_line, "Blog_figures/figure1_line.html", selfcontained = F, libdir = "index_files")
```

```{r}
(figure1_bar <- plot_ly(hovertemplate = paste0("Number of deaths: ","%{y}")) %>% 
    add_trace(data = filter(yearly_suicides, sex=="Total"),
              type = "scatter",
              mode = "lines",
              x = ~year_of_death,
              y = ~n,
              line = list(width = 4, dash="dash", color=custom_colours[3]), 
              name="Total") %>% 
    add_trace(data = filter(yearly_suicides, sex=="Male"),
              type="bar",
              x = ~year_of_death,
              y = ~n,
              marker = list(color=custom_colours[4]),
              name = "Male") %>% 
    add_trace(data = filter(yearly_suicides, sex=="Female"),
              type="bar",
              x = ~year_of_death,
              y = ~n,
              marker = list(color=custom_colours[2]),
              name = "Female") %>% 
    layout(xaxis = list(title = "Year",
                        tickvals = list(2005,2007,2009,2011,2013,2015,2017,2019,2021),
                        range = c(2004, 2022)),
           yaxis = list(title = "Number of suicides",
                        range = c(0, 10)),
           font = list(size = 14),
           legend = list(x = 0.08, y = 0.93, bgcolor = "rgba(0, 0, 0, 0)")) %>% 
    add_annotations(x = 2021,
                    y = 3.5,
                    text = "*",
                    xref = "x",
                    yref = "y",
                    showarrow = FALSE))

saveWidget(figure1_bar, "Blog_figures/figure1_bar.html", selfcontained = F, libdir = "index_files")
```

Figure 2
```{r}
suicides_age_sex = suicides %>% 
  count(age_years, sex) %>% 
  complete(age_years, sex, fill=list(n=0))

(figure2 <- plot_ly(
              data = suicides_age_sex,
              type = "bar",
              x = ~age_years,
              y = ~n,
              color = ~sex,
              colors = custom_colours[c(2,4)],
              hovertemplate = paste0("Number of deaths: ","%{y}")) %>% 
    layout(xaxis = list(title = "Age (years)"),
           yaxis = list(title = "Number of suicides",
                        range = c(0, 26)),
           font = list(size = 14),
           legend = list(x = 0.08, y = 0.93, bgcolor = "rgba(0, 0, 0, 0)")))

saveWidget(figure2, "Blog_figures/figure2.html", selfcontained = F, libdir = "index_files")
```

Figure 3
```{r}
# Deaths rates by region - load and transform data
postcode_denominators = read_csv("C:\\Users\\jagvan\\OneDrive - South Australia Government\\Code\\Population\\postcode_denominators_SRA.csv")

numerator_region <- suicides %>%
  filter(!is.na(region)) %>% 
  count(region)

denominator_region <- postcode_denominators %>%
  filter(!is.na(region),
         age_years >= min_age & age_years <= max_age) %>%
  group_by(region) %>%
  summarise_at("adjusted_population", sum) %>%
  ungroup()

rates_regions <- numerator_region %>%
  right_join(denominator_region, by = "region") %>%
  mutate(rate = (n/adjusted_population)*100000) %>% 
  mutate_all(~replace(., is.na(.), 0))
```

```{r}
map_colours <- c("#FFFFFF", "#FEB627")
pal <- colorRampPalette(map_colours)
colourscale <- pal(100)

map_df_json <- fromJSON(file = "C:/Users/jagvan/OneDrive - South Australia Government/Code/Population/gov_regions/SAGovtRegions_GDA2020.json")

(figure3 <- plot_ly() %>% 
  add_trace(type="choroplethmapbox",
            geojson=map_df_json,
            locations=rates_regions$region,
            z=round(rates_regions$rate,2),
            colors=colourscale,
            zmax=13,
            zmin=0,
            featureidkey="properties.region",
            marker=list(opacity=0.75),
            text=rates_regions$region,
            hovertemplate=paste0("Suicide rate: %{z} \n",
                                 "Number of suicides: ",
                                 rates_regions$n,
                                 "<extra>%{text}</extra>")) %>% 
  colorbar(title = "Suicide rate\nper 100,000\nresident\npopulation\n \n ",
           x=1, y=1,
           len=1) %>% 
  layout(mapbox=list(style="carto-positron",
                     zoom=4.5,
                     center=list(lon=135, lat=-33))))

saveWidget(figure3, "Blog_figures/figure3.html", selfcontained = F, libdir = "index_files")
```


